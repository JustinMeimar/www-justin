const tt=window;function et(r,z,F={}){const l={tab:"	",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:tt,...F},O=l.window,h=O.document,A=[],y=[];let c=-1,L=!1,m=()=>{},R;r.setAttribute("contenteditable","plaintext-only"),r.setAttribute("spellcheck",l.spellcheck?"true":"false"),r.style.outline="none",r.style.overflowWrap="break-word",r.style.overflowY="auto",r.style.whiteSpace="pre-wrap";const x=(t,e)=>{z(t,e)};let k=!1;r.contentEditable!=="plaintext-only"&&(k=!0),k&&r.setAttribute("contenteditable","true");const I=j(()=>{const t=d();x(r,t),f(t)},30);let M=!1;const H=t=>!V(t)&&!W(t)&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Alt"&&!t.key.startsWith("Arrow"),X=j(t=>{H(t)&&(N(),M=!1)},300),E=(t,e)=>{A.push([t,e]),r.addEventListener(t,e)};E("keydown",t=>{t.defaultPrevented||(R=b(),l.preserveIdent?Z(t):U(t),l.catchTab&&J(t),l.addClosing&&G(t),l.history&&(Y(t),H(t)&&!M&&(N(),M=!0)),k&&!v(t)&&f(d()))}),E("keyup",t=>{t.defaultPrevented||t.isComposing||(R!==b()&&I(),X(t),m(b()))}),E("focus",t=>{L=!0}),E("blur",t=>{L=!1}),E("paste",t=>{N(),$(t),N(),m(b())}),E("cut",t=>{N(),Q(t),N(),m(b())});function d(){const t=T(),e={start:0,end:0,dir:void 0};let{anchorNode:n,anchorOffset:o,focusNode:s,focusOffset:i}=t;if(!n||!s)throw"error1";if(n===r&&s===r)return e.start=o>0&&r.textContent?r.textContent.length:0,e.end=i>0&&r.textContent?r.textContent.length:0,e.dir=i>=o?"->":"<-",e;if(n.nodeType===Node.ELEMENT_NODE){const a=h.createTextNode("");n.insertBefore(a,n.childNodes[o]),n=a,o=0}if(s.nodeType===Node.ELEMENT_NODE){const a=h.createTextNode("");s.insertBefore(a,s.childNodes[i]),s=a,i=0}return B(r,a=>{if(a===n&&a===s)return e.start+=o,e.end+=i,e.dir=o<=i?"->":"<-","stop";if(a===n)if(e.start+=o,!e.dir)e.dir="->";else return"stop";else if(a===s)if(e.end+=i,!e.dir)e.dir="<-";else return"stop";a.nodeType===Node.TEXT_NODE&&(e.dir!="->"&&(e.start+=a.nodeValue.length),e.dir!="<-"&&(e.end+=a.nodeValue.length))}),r.normalize(),e}function f(t){const e=T();let n,o=0,s,i=0;if(t.dir||(t.dir="->"),t.start<0&&(t.start=0),t.end<0&&(t.end=0),t.dir=="<-"){const{start:u,end:p}=t;t.start=p,t.end=u}let a=0;B(r,u=>{if(u.nodeType!==Node.TEXT_NODE)return;const p=(u.nodeValue||"").length;if(a+p>t.start&&(n||(n=u,o=t.start-a),a+p>t.end))return s=u,i=t.end-a,"stop";a+=p}),n||(n=r,o=r.childNodes.length),s||(s=r,i=r.childNodes.length),t.dir=="<-"&&([n,o,s,i]=[s,i,n,o]);{const u=_(n);if(u){const w=h.createTextNode("");u.parentNode?.insertBefore(w,u),n=w,o=0}const p=_(s);if(p){const w=h.createTextNode("");p.parentNode?.insertBefore(w,p),s=w,i=0}}e.setBaseAndExtent(n,o,s,i),r.normalize()}function _(t){for(;t&&t!==r;){if(t.nodeType===Node.ELEMENT_NODE){const e=t;if(e.getAttribute("contenteditable")=="false")return e}t=t.parentNode}}function P(){const e=T().getRangeAt(0),n=h.createRange();return n.selectNodeContents(r),n.setEnd(e.startContainer,e.startOffset),n.toString()}function K(){const e=T().getRangeAt(0),n=h.createRange();return n.selectNodeContents(r),n.setStart(e.endContainer,e.endOffset),n.toString()}function Z(t){if(t.key==="Enter"){const e=P(),n=K();let[o]=q(e),s=o;if(l.indentOn.test(e)&&(s+=l.tab),s.length>0?(g(t),t.stopPropagation(),C(`
`+s)):U(t),s!==o&&l.moveToNewLine.test(n)){const i=d();C(`
`+o),f(i)}}}function U(t){if(k&&t.key==="Enter")if(g(t),t.stopPropagation(),K()==""){C(`
 `);const e=d();e.start=--e.end,f(e)}else C(`
`)}function G(t){const e=`([{'"`,n=`)]}'"`;if(e.includes(t.key)){g(t);const o=d(),s=o.start==o.end?"":T().toString(),i=t.key+s+n[e.indexOf(t.key)];C(i),o.start++,o.end++,f(o)}}function J(t){if(t.key==="Tab")if(g(t),t.shiftKey){const e=P();let[n,o]=q(e);if(n.length>0){const s=d(),i=Math.min(l.tab.length,n.length);f({start:o,end:o+i}),h.execCommand("delete"),s.start-=i,s.end-=i,f(s)}}else C(l.tab)}function Y(t){if(V(t)){g(t),c--;const e=y[c];e&&(r.innerHTML=e.html,f(e.pos)),c<0&&(c=0)}if(W(t)){g(t),c++;const e=y[c];e&&(r.innerHTML=e.html,f(e.pos)),c>=y.length&&c--}}function N(){if(!L)return;const t=r.innerHTML,e=d(),n=y[c];if(n&&n.html===t&&n.pos.start===e.start&&n.pos.end===e.end)return;c++,y[c]={html:t,pos:e},y.splice(c+1);const o=300;c>o&&(c=o,y.splice(0,1))}function $(t){if(t.defaultPrevented)return;g(t);const n=(t.originalEvent??t).clipboardData.getData("text/plain").replace(/\r\n?/g,`
`),o=d();C(n),x(r),f({start:Math.min(o.start,o.end)+n.length,end:Math.min(o.start,o.end)+n.length,dir:"<-"})}function Q(t){const e=d(),n=T();(t.originalEvent??t).clipboardData.setData("text/plain",n.toString()),h.execCommand("delete"),x(r),f({start:Math.min(e.start,e.end),end:Math.min(e.start,e.end),dir:"<-"}),g(t)}function B(t,e){const n=[];t.firstChild&&n.push(t.firstChild);let o=n.pop();for(;o&&e(o)!=="stop";)o.nextSibling&&n.push(o.nextSibling),o.firstChild&&n.push(o.firstChild),o=n.pop()}function S(t){return t.metaKey||t.ctrlKey}function V(t){return S(t)&&!t.shiftKey&&D(t)==="Z"}function W(t){return S(t)&&t.shiftKey&&D(t)==="Z"}function v(t){return S(t)&&D(t)==="C"}function D(t){let e=t.key||t.keyCode||t.which;if(e)return(typeof e=="string"?e:String.fromCharCode(e)).toUpperCase()}function C(t){t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),h.execCommand("insertHTML",!1,t)}function j(t,e){let n=0;return(...o)=>{clearTimeout(n),n=O.setTimeout(()=>t(...o),e)}}function q(t){let e=t.length-1;for(;e>=0&&t[e]!==`
`;)e--;e++;let n=e;for(;n<t.length&&/[ \t]/.test(t[n]);)n++;return[t.substring(e,n)||"",e,n]}function b(){return r.textContent||""}function g(t){t.preventDefault()}function T(){return r.parentNode?.nodeType==Node.DOCUMENT_FRAGMENT_NODE?r.parentNode.getSelection():O.getSelection()}return{updateOptions(t){Object.assign(l,t)},updateCode(t){r.textContent=t,x(r),m(t)},onUpdate(t){m=t},toString:b,save:d,restore:f,recordHistory:N,destroy(){for(let[t,e]of A)r.removeEventListener(t,e)}}}export{et as CodeJar};
